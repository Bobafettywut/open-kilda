@startuml
title FLOW ping(verification) topology

control kilda.ping
control Time

control kilda.stats
control kilda.flow.status

participant InputDecoder
participant InputRouter

participant FlowFetcher
participant Neo4j

participant PingProducer
participant PingRouter
participant Blacklist
participant TimeoutManager
participant ResultDispatcher
participant PeriodicResultManager
participant GroupCollector
participant StatsProducer
participant FailReporter
participant SpeakerEncoder

control kilda.speaker

participant FL

control SW.source
control SW.dest

note right of FlowFetcher: must be 1\nin system

Time -> FlowFetcher: ping tick
activate FlowFetcher
FlowFetcher -> Neo4j: fetch all flow
activate Neo4j
Neo4j -> FlowFetcher: [flows]
deactivate Neo4j

note right of FlowFetcher: for each flow
FlowFetcher -> PingProducer: PingContext\n(field grouping)
deactivate FlowFetcher

activate PingProducer
note right of PingProducer: make ping request\n(source+dest)
PingProducer -> PingRouter: PingContext
deactivate PingProducer
activate PingRouter
PingRouter -> Blacklist: PingContext\n(field grouping)
deactivate PingRouter

activate Blacklist
alt blacklisted
Blacklist ->x Blacklist: drop request
else normal workflow
Blacklist -> PingRouter: PingContext
activate PingRouter
end
deactivate Blacklist

PingRouter -> TimeoutManager: PingContext\n(field grouping)
deactivate PingRouter

activate TimeoutManager
note right of TimeoutManager: scheduleTimeout for\npingId
TimeoutManager -> SpeakerEncoder: PingRequest

activate SpeakerEncoder
SpeakerEncoder -> kilda.speaker: json{PingRequest}
deactivate SpeakerEncoder

kilda.speaker -> FL: json{PingRequest}
activate FL
note right of FL: make PingPackage
FL -> SW.source: PingPackage
deactivate FL

alt normal workflow
    SW.source -> SW.dest: PingPackage
    activate FL
    alt normal workflow
        SW.dest -> FL: PingPackage
        note right of FL: measure flow\nlatency
    else lack of capabilities
        note right of FL: Sw.dest is not\ncapable to catch ping
    end

    note right of FL: make PingResponse
    FL -> kilda.ping: json{PingResponse}
    deactivate FL

    kilda.ping -> InputDecoder: json{PingResponse}

    activate InputDecoder
    InputDecoder -> InputRouter: PingResponse
    deactivate InputDecoder
    activate InputRouter
    InputRouter -> PingRouter: PingResponse
    deactivate InputRouter

    PingRouter -> TimeoutManager: PingResponse\n(field grouping)
    note right of TimeoutManager: cancel timeout

    TimeoutManager -> ResultDispatcher: PingContext
    activate ResultDispatcher
    ResultDispatcher -> PeriodicResultManager: PingContext
    deactivate ResultDispatcher
    activate PeriodicResultManager
    alt get permanent error
        PeriodicResultManager -> PingRouter: PingContext

        activate PingRouter
        PingRouter -> Blacklist: PingContext\n(field grouping)
        deactivate PingRouter
        activate Blacklist

        Blacklist ->x Blacklist: update blacklist
        deactivate Blacklist
    end
    PeriodicResultManager -> FailReporter: PingContext\n(flowId grouping)
    note right of FailReporter: update flow status
    PeriodicResultManager -> GroupCollector: PingContext\n(flowId grouping)

    activate GroupCollector
    GroupCollector -> PeriodicResultManager: Group
    deactivate GroupCollector

    PeriodicResultManager -> StatsProducer: Group
    deactivate PeriodicResultManager

    activate StatsProducer
    StatsProducer -> kilda.stats: flow ping stats
    deactivate StatsProducer

else timeout
    Time -> TimeoutManager: X monotonic tick
    Time -> TimeoutManager: X + N monotonic tick
    note right of TimeoutManager: log error
    TimeoutManager -> ResultDispatcher: PingContext
    deactivate TimeoutManager
    activate ResultDispatcher
    ResultDispatcher -> PeriodicResultManager: PingContext
    deactivate ResultDispatcher
    activate PeriodicResultManager

    PeriodicResultManager -> FailReporter: PingContext\n(field grouping)
    deactivate PeriodicResultManager
    activate FailReporter

    note right of FailReporter: set fail flag

    Time -> FailReporter: X monotonic tick
    Time -> FailReporter: X + M monotonic tick

    FailReporter -> kilda.flow.status: report flow failure

    deactivate FailReporter
end
deactivate TimeoutManager

@enduml
